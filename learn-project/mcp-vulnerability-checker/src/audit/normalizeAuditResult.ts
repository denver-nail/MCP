import { NpmAuditReport, Vulnerability } from "../types/npmAudit.js";
import { getDepChain } from "./getDepChain.js";
import {
  AuditBuckets,
  NormalizedAudit,
  NormalizedPackage,
} from "../types/customAudit.js";

function _normalizeAuditResult(auditResult: NpmAuditReport): AuditBuckets {
  const result: AuditBuckets = {
    critical: [],
    high: [],
    moderate: [],
    low: [],
    info: [],
  };
  for (const key in auditResult.vulnerabilities) {
    const packageInfo = auditResult.vulnerabilities[key];
    const normalizedPackage = _normalizePackage(packageInfo);
    if (normalizedPackage) {
      result[normalizedPackage.severity].push(normalizedPackage);
    }
  }
  return result;

  function _normalizePackage(
    packageInfo: Vulnerability
  ): NormalizedPackage | null {
    const { via = [] } = packageInfo;
    const vaildVia = via.filter((item) => typeof item === "object");
    if (via.length === 0) {
      return null;
    }
    const info: NormalizedPackage = {
      name: packageInfo.name,
      severity: packageInfo.severity,
      problems: vaildVia as NormalizedPackage["problems"],
      effects: packageInfo.effects,
      range: packageInfo.range,
      nodes: packageInfo.nodes || [],
      fixAvailable: packageInfo.fixAvailable,
      depChain: getDepChain(packageInfo, auditResult.vulnerabilities),
    };
    return info;
  }
}

export function normalizeAuditResult(
  auditResult: NpmAuditReport
): NormalizedAudit {
  return { vulnerabilities: _normalizeAuditResult(auditResult) };
}
