import { npmAudit } from "./npmAudit.js";
import { normalizeAuditResult } from "./normalizeAuditResult.js";
import { currentAudit } from "./currerntAudit.js";
import { NormalizedAudit } from "../types/customAudit.js";
import fs from "fs";

export async function audit(
  workDir: string,
  packageJson: any
): Promise<NormalizedAudit> {
  const auditResult = await npmAudit(workDir);
  await fs.promises.writeFile(
    `D:\\Codes\\MCP\\learn-project\\mcp-vulnerability-checker\\work\\npmAudit.json`,
    JSON.stringify(auditResult)
  );
  const normalizedResult = normalizeAuditResult(auditResult);
  await fs.promises.writeFile(
    `D:\\Codes\\MCP\\learn-project\\mcp-vulnerability-checker\\work\\normalizedResult.json`,
    JSON.stringify(auditResult)
  );
  const current = await currentAudit(packageJson.name, packageJson.version);
  if (current) {
    normalizedResult.vulnerabilities[current.severity].unshift(current);
  }
  // 添加汇总信息
  normalizedResult.summary = {
    total: Object.values(normalizedResult.vulnerabilities).reduce(
      (sum, arr) => sum + arr.length,
      0
    ),
    critical: normalizedResult.vulnerabilities.critical.length,
    high: normalizedResult.vulnerabilities.high.length,
    moderate: normalizedResult.vulnerabilities.moderate.length,
    low: normalizedResult.vulnerabilities.low.length,
  };
  return normalizedResult;
}
